<html>
<head>
  <title>上传文件到github</title>
</head>
<body>
  <h1>上传文件到github</h1>
  <form id="upload-form">
    <p>
      <label for="username">github帐号：</label>
      <input type="text" id="username" name="username" value="laoma89" required>
    </p>
    <p>
      <label for="password">github密码：</label>
      <input type="password" id="password" name="password" value="qwe123789aa" required>
    </p>
    <p>
      <label for="repo">仓库名：</label>
      <input type="text" id="repo" name="repo" value="gr" required>
    </p>
    <p>
      <label for="file">选择文件：</label>
      <input type="file" id="file" name="file" accept="image/gif" required>
    </p>
    <p>
      <button type="submit" id="submit">上传</button>
    </p>
  </form>
  <div id="result"></div>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    // 获取表单元素
    const form = document.getElementById("upload-form");
    const username = document.getElementById("username");
    const password = document.getElementById("password");
    const repo = document.getElementById("repo");
    const file = document.getElementById("file");
    const submit = document.getElementById("submit");
    const result = document.getElementById("result");

    // 监听表单提交事件
    form.addEventListener("submit", function (event) {
      // 阻止表单默认提交行为
      event.preventDefault();
      // 禁用提交按钮，防止重复提交
      submit.disabled = true;
      // 清空结果显示区域
      result.innerHTML = "";
      // 获取表单数据
      const data = new FormData(form);
      // 生成一个token，用于验证github api请求
      const token = btoa(username.value + ":" + password.value);
      // 获取文件名
      const fileName = file.files[0].name;
      // 获取文件内容
      const fileContent = file.files[0];
      // 将文件内容转换为base64编码
      const reader = new FileReader();
      reader.readAsDataURL(fileContent);
      reader.onload = function () {
        // 去掉base64编码的前缀
        const base64 = reader.result.split(",")[1];
        // 构造请求数据
        const payload = {
          message: "upload file",
          committer: {
            name: username.value,
            email: username.value + "@gmail.com"
          },
          content: base64
        };
        // 构造请求地址
        const url = "https://api.github.com/repos/" + username.value + "/" + repo.value + "/contents/" + fileName;
        // 发送put请求，上传文件到github仓库
        axios.put(url, payload, {
          headers: {
            "Authorization": "Basic " + token
          }
        }).then(function (response) {
          // 上传成功，显示结果
          result.innerHTML = "<p>上传成功！</p>";
          // 获取文件的sha值
          const sha = response.data.content.sha;
          // 构造cdn链接
          const cdnUrl = "https://cdn.jsdelivr.net/gh/" + username.value + "/" + repo.value + "/" + fileName;
          // 显示cdn链接
          result.innerHTML += "<p>cdn链接：<a href='" + cdnUrl + "' target='_blank'>" + cdnUrl + "</a></p>";
          // 显示文件的sha值
          result.innerHTML += "<p>文件sha值：" + sha + "</p>";
          // 启用提交按钮
          submit.disabled = false;
        }).catch(function (error) {
          // 上传失败，显示错误信息
          result.innerHTML = "<p>上传失败！</p>";
          result.innerHTML += "<p>错误信息：" + error.message + "</p>";
          // 启用提交按钮
          submit.disabled = false;
        });
      };
    });
  </script>
</body>
</html>
